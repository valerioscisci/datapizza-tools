# Thought Process

- Configurazione iniziale del progetto: creati agenti `datapizza-tools-*` indicando le regole di coding, stili e best practice sia per il fe che per il be
- Aggiornato `CLAUDE.md` con le istruzioni da eseguire ad ogni prompt, commit e per migliorare la gestione del contesto
- Aggiunte istruzioni post-prompt in `CLAUDE.md`: aggiornamento automatico di README.md, THOUGHT_PROCESS.md e agenti dopo ogni prompt completato
- **Visione del progetto**: il mercato del lavoro tech nei prossimi 6-12 mesi sara' stravolto dall'introduzione dei workflow agentici. Si stima che il 60-70% dei lavori digitali saranno impattati. Datapizza deve posizionarsi come punto di riferimento per aiutare gli sviluppatori a navigare questo cambiamento, acquisire nuove competenze e trovare nuovi ruoli
- **Scelte tecniche**: SQLite locale per comodita' e zero costi di hosting nella fase iniziale. FastAPI per lo sviluppo rapido e la possibilita' di deploy su AWS o Vercel (versione Python scelta per compatibilita' con altri progetti esistenti). Next.js con App Router come standard per tutti i nuovi progetti
- **Funzionalita' core pianificate**: (1) replicare e migliorare la job board esistente di Datapizza, (2) profili candidato con tech stack, notifiche giornaliere su corsi AI e progetti di reskilling (newsletter o bot Telegram), (3) "Craft Your Developer" - prodotto B2B a pagamento dove le aziende possono progettare percorsi formativi per candidati specifici e assumerli dopo il reskilling
- **Flusso "Craft Your Developer"**: le aziende navigano i profili dei candidati in cerca di lavoro, selezionano un candidato, progettano un training program personalizzato con corsi e competenze AI necessarie, e poi lo assumono. Questo flusso sara' probabilmente a pagamento per l'azienda
- **Ralph Loop**: deciso di usare il ralph-loop per migliorare lo sviluppo di task lunghi e la gestione del contesto — permette di iterare sullo stesso prompt vedendo il lavoro precedente nei file e nella git history
- **Agenti specializzati**: deciso di usare un set di agenti specializzati (debugger, feature-builder, code-reviewer per BE e FE) per risparmiare context window e essere molto specifici nei piccoli task assegnati
- **Pro Workflow plugin**: deciso di usare il plugin Pro Workflow per non dover ripetere ogni volta le correzioni alle allucinazioni dell'LLM e ai problemi derivanti dal context rot — le correzioni vengono salvate in un database SQLite e applicate automaticamente nelle sessioni successive
- **Design system Datapizza**: estratta la palette colori completa dal sito datapizza.tech — colore primario azure-600 (#1b64f5), font heading Oddval SemiBold, body Poppins, tema solo light. Aggiornati tutti e 3 gli agenti FE (feature-builder, code-reviewer, debugger) con la palette completa, i token semantici, le regole di layout e tipografia
- **SQLite come database**: aggiornati tutti e 3 gli agenti BE per usare SQLite invece di PostgreSQL. Rimossi riferimenti a JSONB, ARRAY, UUID PostgreSQL e sostituiti con pattern compatibili SQLite (TEXT per JSON, String(36) per UUID). Scelta fatta per comodita' e zero costi nella fase iniziale
- **Scaffolding completato**: creato monorepo con pnpm workspaces + Turborepo. FE: Next.js 16.0.11, React 19, Tailwind v4, next-intl con solo locale italiano. BE: FastAPI + SQLAlchemy + SQLite con 10 job finti nel seed. Porte: FE 3003, BE 8003
- **Homepage replicata**: ispirata a datapizza.tech/it con hero section, stats (150+ offerte, 100+ aziende, 50k+ developer), sezione servizi (Craft Your Developer, Mercato del Lavoro, AI Reskilling coming soon), community social stats, CTA finale
- **Pagina Craft Your Developer**: creata landing page B2B completa con: hero, sezione problema del recruiting tech, 4 benefit (formazione mirata, costi ridotti, qualita' garantita, time-to-hire ridotto), 4 step del processo (esplora profili, progetta percorso, formazione guidata, assumi), confronto hiring tradizionale vs CYD, CTA finale
- **Mercato del Lavoro**: pagina jobs con filtri per work_mode (remoto/ibrido/in sede), card con titolo, azienda, location, badge work_mode, salary range, tags tech, descrizione, paginazione. Dati dal BE via fetch API
- **Traduzioni solo italiano**: configurato next-intl con `locales: ['it']`, tutti i testi in `messages/it.json`. Aggiornati agenti FE con questa informazione
- **Monorepo + Turborepo**: deciso di procedere con un approccio monorepo perche' e' lo standard de facto per progetti grandi al momento. Turborepo e' stato scelto perche' quando si builda con Vercel aiuta ad automatizzare il workflow di CD/CI e riduce le build non necessarie
- **Cleanup e code review completa**: eseguita una pulizia completa di tutte le pagine. Rimossa la newsletter dal footer. Aggiunti link reali (termini, privacy, cookie da jobs.datapizza.tech). Corretti tutti i link social (Spotify URL fixato). Aggiunto cursor-pointer su tutti gli elementi interattivi come da standard
- **Jobs Market migliorato**: redesign completo delle card con emoji badge colorati (salario giallo, esperienza azure, work_mode verde, location neutro, welfare rosso), tech tags con priorita' verde, layout 2 colonne, dialog dettaglio job con chiusura su Escape e click esterno
- **Arricchimento dati job**: aggiunti campi experience_years, smart_working, welfare, language al modello DB, schema Pydantic e API. Seed aggiornato con dati realistici per tutti i 10 job
- **Code review FE+BE**: eseguite code review complete con agenti specializzati. Fixati: API URL hardcoded -> env variable, error handling API response, accessibilita' dialog (role="dialog", aria-modal, aria-labelledby), keyboard accessibility su JobCard (tabIndex, role="button", onKeyDown), cursor-pointer mancante su hamburger menu, bottone Candidati collegato ad apply_url, bottone Contattaci CYD collegato a datapizza.tech
- **Autenticazione utente**: implementato sistema auth completo con JWT + bcrypt. Modello User con campi profilo (skills, experience, location, availability_status, reskilling_status, adopted_by_company) pensato per supportare sia il flusso candidato che il futuro flusso CYD B2B. Token JWT con scadenza 24h, secret configurabile via env JWT_SECRET
- **Modello Application**: creato sistema candidature con UniqueConstraint su (user_id, job_id) per prevenire duplicati. Status a 4 valori (proposta/da_completare/attiva/archiviata) con status_detail per info aggiuntive e campi recruiter per tracciare il contatto aziendale
- **Pagine auth FE**: login e signup con form semplici, validazione client-side (password match, lunghezza minima), redirect automatico a /it/jobs dopo successo. AuthContext con React Context API, token in localStorage, validazione on mount via GET /auth/me
- **Navbar aggiornata**: aggiunta sezione auth (desktop: avatar iniziale + link candidature + bottone esci; mobile: stessa logica nel menu hamburger). "Accedi" e "Registrati" quando non loggato. "Le mie candidature" nel dropdown Talents quando loggato
- **Pagina candidature**: replicata UI simile a jobs.datapizza.tech/applications con hero, 4 tab di stato con badge conteggio, card candidatura con info job (salary, experience, work_mode), tech tags, dettagli recruiter e data. Empty state per tab vuoti
- **Bottone Candidati nel job dialog**: integrato con auth — se loggato fa POST /applications, se non loggato redirect a login. Gestione stati success/duplicate/loading. Se il job ha apply_url usa il link esterno come fallback
- **Seed ampliato**: 10 profili developer italiani realistici (nomi, ruoli, skill, citta' diverse) + 6 candidature di esempio distribuite su diversi status. Password hash per tutti "password123" per dev
- **Code review iterativa con Ralph Loop**: eseguiti 2 round completi di code review BE+FE con agenti specializzati + 17 test Playwright E2E. Fixati tutti i BLOCKER e CRITICAL (JWT secret env check, N+1 query, email validation, token expiry check client-side, typed API responses). Secondo round di review ha trovato e fixato: .env JWT_SECRET naming mismatch, get_application JOIN, safe_parse_json_list type validation, errori hardcoded in login/signup, useCallback su login/signup/logout, body scroll lock nel dialog, shared utility per formatSalary/formatDate/workModeLabel, i18n per stringhe nel dialog e paginazione
- **Deduplicazione utility**: estratte funzioni condivise in moduli dedicati sia BE (api/utils.py con safe_parse_json_list) che FE (lib/job-utils.ts con formatSalary, formatDate, workModeLabel). Eliminata duplicazione tra jobs.py, applications.py, auth.py lato BE e tra jobs/page.tsx e candidature/page.tsx lato FE
- **Migrazione a NextAuth v5**: rimosso il sistema auth custom (AuthContext.tsx con JWT in localStorage, client-side token expiry check) e sostituito con next-auth@5.0.0-beta.30. Credentials provider che chiama il backend POST /auth/login + GET /auth/me per ottenere token e profilo utente. Session in httpOnly cookie (piu' sicuro di localStorage). Backend FastAPI rimasto invariato — NextAuth lo wrappa lato FE. Creati: auth.ts (config NextAuth), use-auth.ts (hook custom), route handler [...nextauth], type declarations, Providers.tsx (SessionProvider wrapper). Login usa signIn('credentials'), signup usa flusso a due step (POST signup diretto + signIn per creare sessione). Aggiornate tutte le pagine (login, signup, navbar, candidature, jobs) per usare il nuovo hook useAuth da lib/auth/use-auth
- **Backend News e Corsi**: aggiunti modelli News e Course in models.py seguendo esattamente i pattern esistenti (String(36) UUID, tags_json TEXT, is_active Integer, timestamps UTC). Creati schema Pydantic (NewsResponse, CourseResponse con tags: list[str] tramite safe_parse_json_list) e route FastAPI (GET /news con filtro category AI/tech/careers, GET /news/{id} con 404; GET /courses con filtri category e level, GET /courses/{id} con 404). Ordinamento: news per published_at desc, corsi per created_at desc. Seed con 10 news realistiche (temi AI/tech/careers da HN e TLDR) e 10 corsi realistici (Coursera/Udemy con istruttori, rating, studenti). Route registrate in main.py su /api/v1. Tutti gli endpoint testati e funzionanti
- **Pagine FE News e Corsi**: create le pagine news/page.tsx e courses/page.tsx seguendo esattamente il pattern della pagina jobs (hero, filtri per categoria, griglia 2 colonne di card, dialog dettaglio, paginazione, escape per chiudere). News: filtri all/AI/tech/careers, card con icona Newspaper, badge colorato per categoria (AI=azure, tech=pastelgreen, careers=yellow), tags, summary, data pubblicazione con icona Calendar. Corsi: filtri all/AI/ML/frontend/backend/devops, card con icona GraduationCap, badge livello colorato (beginner=verde, intermediate=azure, advanced=rosso), durata, prezzo, rating con stella, tags. Dialog per entrambi con scroll lock, chiusura su Escape e click esterno, bottone CTA esterno ("Leggi l'articolo" / "Vai al Corso"). Aggiornata Navbar con link "News Tech" e "Corsi di Formazione" nel dropdown Talenti (desktop e mobile). Aggiunte tutte le traduzioni i18n in it.json. Riutilizzato formatDate da job-utils.ts. TypeScript check passato senza errori
- **Code review e fix completati**: eseguite code review BE+FE con agenti specializzati. BE: aggiunti indici composite su News (is_active+published_at, category) e Course (is_active+created_at, category, level) per query performance; fixato session leak in seed con try/finally; estratti helper \_to_news_response e \_to_course_response per eliminare duplicazione. FE: estratto TechTag in componente condiviso @/components/ui/TechTag.tsx (eliminata duplicazione tripla tra jobs, news, courses); spostato handler Escape dentro i dialog component invece che a livello pagina; aggiunto aria-pressed su filtri, aria-live="polite" su contenuto dinamico, aria-hidden su icone decorative Star. Rimosso import useRef inutilizzato da jobs/page.tsx
- **Footer aggiornato**: aggiunti link "News Tech" e "Corsi di Formazione" nella sezione Pagine del footer, allineando la navigazione footer con quella della navbar
- **GitHub Action per fetch notturno di contenuti**: creata una GitHub Action disabilitata (solo workflow_dispatch, cron commentato per le 01:00 AM UTC) che dimostra come popolare automaticamente il database con news e corsi ogni notte. Scelta architetturale chiave: invece di scrivere un classico scraper Python (fragile, si rompe al minimo cambiamento della struttura HTML), si usa **Claude Code come agente** (`npx @anthropic-ai/claude-code --print`), lo stesso pattern usato nel progetto next-monorepo per il daily changelog. L'agente legge le istruzioni da `.claude/agents/datapizza-tools-content-fetcher.md`, fetcha contenuti da 4 fonti (HN API, TLDR Tech, Coursera, Udemy) e li inserisce nel DB usando lo script CLI `apps/api/api/scrapers/insert_content.py`. Lo script CLI riceve JSON da stdin, deduplicata per source_url/url e title+source/provider, e inserisce usando gli stessi modelli SQLAlchemy. Testato localmente: inserimento, deduplicazione e cleanup funzionano correttamente
- **Profile feature backend**: implementato il backend completo per la gestione del profilo utente. Aggiunti 2 nuovi modelli SQLAlchemy (Experience, Education) con indici su user_id per performance delle query. Aggiunti 3 nuovi campi URL (linkedin_url, github_url, portfolio_url) al modello User esistente. Creati 3 nuovi file di schema Pydantic (profile.py, experience.py, education.py) per validazione input/output con conversione automatica is_current Integer/bool tra DB e API. Creato routes/profile.py con 8 endpoint CRUD completi: GET/PATCH profilo (con gestione speciale skills JSON), POST/PATCH/DELETE esperienze lavorative, POST/PATCH/DELETE formazione. Ogni endpoint verifica che la risorsa appartenga all'utente autenticato. Aggiornato anche UserResponse in schemas/auth.py e \_user_to_response in routes/auth.py per includere i nuovi campi URL. Seed ampliato con 13 esperienze lavorative e 8 percorsi formativi realistici per i primi 5 utenti italiani. La scelta di usare hard delete (non soft delete) per esperienze e formazione e' stata fatta perche' sono dati personali dell'utente, non risorse condivise — pattern diverso rispetto ai job che hanno is_active per soft delete
- **Pagina Profilo FE**: creata pagina /it/profilo completa come single-file page (pattern progetto). Struttura: ProfileHeader con avatar iniziale grande, nome, ruolo, location, badge disponibilita' colorato (verde/azure/giallo), link social (LinkedIn, GitHub, Portfolio), bottone "Modifica Profilo". ProfileEditModal con form completo per tutti i campi profilo (nome, telefono, bio, location, ruolo, livello, anni esperienza, disponibilita', URL social) con chiusura su Escape e click esterno + scroll lock. SkillsSection con pill tag editabili inline (aggiungi con input + Enter, rimuovi con X su ogni pill), salvataggio immediato via PATCH. ExperienceSection e EducationSection con CRUD completo (form inline per add/edit, conferma per delete, loading states con Loader2). Aggiornata Navbar con link "Il mio Profilo" in 3 posizioni: desktop right-side (prima di candidature), dropdown Talenti, menu mobile. Aggiunte tutte le traduzioni i18n (60+ chiavi) incluse opzioni per availability, experience_levels, employment_types, degree_types. TypeScript check passato senza errori
- **Code review FE pagina Profilo**: eseguita code review completa con agente FE code-reviewer. Trovati e fixati 5 CRITICAL: (1) hook ordering violato — useAuth prima di useRouter nel main component, corretto seguendo il 9-step pattern; (2) type safety — handleChange nel ProfileEditModal usava `field: string` invece di `keyof typeof formData`; (3) silent error swallowing — ExperienceSection e EducationSection avevano catch block vuoti senza feedback utente, aggiunti stato `feedback` e messaggio errore visibile; (4) non-null assertions `accessToken!` rischiose su 3 componenti, aggiunto guard `!accessToken` nell'early return e rimossi gli `!`; (5) stringa hardcoded "es. 3-5 anni" nel placeholder, estratta in i18n come `experienceYearsPlaceholder`. Navbar e traduzioni it.json revisionate senza problemi. TypeScript check passato senza errori dopo tutti i fix
- **Test E2E Playwright pagina Profilo**: creata suite di 6 test Playwright in `apps/web/tests/profile.spec.ts` con config dedicata in `tests/playwright.config.ts` (la config principale usa testDir `./e2e`). I test coprono: (1) redirect a login se non autenticato; (2) visualizzazione dati profilo (nome, ruolo, location, bio, 5 skill, esperienze, formazione); (3) modifica profilo via modal (cambio bio, salvataggio, verifica, ripristino); (4) gestione skill (toggle edit mode, aggiunta via input+Enter, rimozione via X); (5) aggiunta esperienza lavorativa (form inline, compilazione campi, submit, verifica, cleanup con delete); (6) aggiunta formazione (form inline, compilazione, submit, verifica, cleanup). Ogni test che aggiunge dati ripulisce dopo se stesso per idempotenza. Login gestito con helper riutilizzabile che naviga su /it/login, compila credenziali e attende redirect a /it/jobs. Trovato e fixato un problema di strict mode Playwright su `getByText('Frontend Developer')` che matchava 4 elementi — risolto con `{ exact: true }`. Tutti i 6 test passano stabilmente su 2 run consecutivi (~14s totali)
- **Test suite backend con pytest**: creata suite completa di 112 test unitari per l'API FastAPI (conftest.py con fixture condivise + tests/unit/test\_\*.py). Struttura: `tests/conftest.py` con 9 fixture (mock_db, mock_user, mock_job, mock_news, mock_course, mock_experience, mock_education, mock_application), `tests/unit/` con 9 file di test. Copertura completa: (1) test_auth.py — hashing bcrypt, token JWT (creazione, claims sub/exp, scadenza), get_current_user (token valido/invalido/scaduto/senza sub/utente inesistente); (2) test_auth_routes.py — signup (creazione utente, email duplicata 409, validazione password corta, email invalida), login (credenziali valide, password sbagliata, email inesistente), get_me; (3) test_jobs_routes.py — list_jobs (ritorno items, lista vuota, filtro work_mode, paginazione con offset corretto, parsing tags_json, gestione tags null); (4) test_news_routes.py — list/get news con filtro category e 404; (5) test_courses_routes.py — list/get courses con filtri category+level (singoli e combinati) e 404; (6) test_profile_routes.py — helper functions, get/update profile (conversione skills JSON, aggiornamento solo campi forniti), CRUD esperienze e formazione (creazione, aggiornamento, is_current che pulisce date fine, cancellazione, ownership check 404); (7) test_applications_routes.py — creazione candidatura (successo, job non trovato 404, duplicato 409), lista con conteggi status, get per id e 404; (8) test_schemas.py — validazione Pydantic per JobResponse, ProfileUpdate, ExperienceCreate, EducationCreate (campi required, min/max length, range numerici); (9) test_utils.py — safe_parse_json_list con tutti i casi limite (JSON valido, invalido, non-lista, tipi misti, None, stringa vuota). Scelta di usare solo mock (unittest.mock.MagicMock) senza database reale per velocita' e isolamento. Aggiunto pytest e pytest-asyncio a requirements.txt. Tutti i 112 test passano in ~3 secondi
- **Riorganizzazione test E2E**: spostato `profile.spec.ts` dalla cartella `tests/` alla cartella `e2e/` dove vivono tutti gli altri test Playwright. Rimosso il `BASE_URL` hardcoded sostituendolo con path relativi (usa `baseURL` dalla config principale `playwright.config.ts`). Rimossa la cartella `tests/` e la config `playwright.config.ts` duplicata. Tutti i 6 test passano dalla nuova posizione
- **Branch rinominato**: da `feature/replicate-the-current-datapizza-main-pages` a `feature/replicate-the-current-datapizza-main-pages-plus-initial-new-features-batch` per riflettere meglio il contenuto del branch che include non solo la replica delle pagine esistenti ma anche nuove feature (profilo, news, corsi, auth, candidature)
- **Aggiornamento agenti reviewer**: aggiornati sia `datapizza-tools-be-code-reviewer.md` che `datapizza-tools-fe-code-reviewer.md` con requisiti obbligatori di test coverage. BE reviewer: ogni endpoint/schema/utility deve avere test unitari pytest con copertura happy path, 404, 401, 422 e data isolation — la test review e' stata promossa da Medium a Critical. FE reviewer: ogni pagina nuova/modificata deve avere test Playwright E2E con smoke test, auth guard, data display e interazioni utente. Entrambi i reviewer ora verificano nella self-verification checklist che i test esistano e siano passanti, creandoli se mancanti
- **Public Developer Profiles (Browse Talents) backend**: implementata la feature completa per la navigazione pubblica dei profili developer. Aggiunto campo `is_public` (Integer, default 0) al modello User con indice composito `ix_users_is_public_is_active` per performance delle query. Creati 2 nuovi schema Pydantic in `schemas/talent.py`: `TalentCardResponse` (card riassuntiva senza email/phone/password) e `TalentDetailResponse` (profilo completo con esperienze e formazione, ma senza dati sensibili). Creato `routes/talents.py` con 2 endpoint pubblici (NO auth required): `GET /talents` con search (full*name, current_role, skills_json via or* ILIKE), filtri (skills comma-separated con OR logic, availability, experience_level, location ILIKE) e paginazione; `GET /talents/{id}` con dettaglio completo incluse esperienze (ordinate per start_year desc) e formazione. Privacy: i profili privati (is_public=0) e inesistenti ritornano entrambi 404 per prevenire enumerazione. Aggiornato `ProfileUpdate` e `ProfileResponse` per includere `is_public` con conversione bool/Integer. Seed aggiornato con 6 utenti pubblici e 4 privati, piu' URL social per Marco Rossi, Giulia Bianchi e Luca Ferrari. Test suite ampliata da 112 a 134 test: 20 nuovi test per talents (13 TestListTalents + 7 TestGetTalent) e 2 nuovi test per is_public nel profilo. Tutti i 134 test passano in ~3 secondi
- **Public Developer Profiles (Browse Talents) frontend**: implementato il frontend completo per il marketplace dei talenti pubblici. (1) Pagina lista `/it/talenti` con ricerca testuale, filtri per livello esperienza (Tutti/Junior/Mid/Senior) e disponibilita' (Tutti/Disponibile/Occupato/In formazione), griglia 2 colonne di TalentCard (avatar iniziale, nome, ruolo, location, badge livello+anni+disponibilita', skill pills con "+N" per overflow, bio troncata), paginazione — pattern visivo identico alla pagina jobs. (2) Pagina dettaglio `/it/talenti/[id]` come versione read-only del profilo: header con avatar, nome, ruolo, location, badge, link social; sezioni bio, skills, esperienze, formazione (stesso layout del profilo ma senza bottoni edit/delete); CTA finale "Interessato a questo talento?" con link a Craft Your Developer; gestione 404 con pagina dedicata. (3) Privacy toggle nella pagina profilo (`PrivacyToggleSection`): card con icona Eye, titolo, descrizione, toggle switch (verde=on, grigio=off), info box azure che spiega cosa significa essere pubblici; chiama PATCH /profile con is_public. (4) Sezione "Scopri i Talenti" nella pagina CYD tra "Come Funziona" e "Confronto". (5) Navbar aggiornata con link "Scopri i Talenti" nel dropdown Aziende (desktop e mobile). (6) Footer aggiornato con link nella sezione Pagine. (7) 70+ nuove chiavi i18n per talents, privacyToggle, e craftYourDeveloper.talents. Le pagine talenti sono pubbliche (nessun auth check). Email e telefono mai esposti. TypeScript check passato senza errori
- **Test E2E Playwright per Browse Talents e Privacy Toggle**: creata suite completa di 13 test Playwright in `apps/web/e2e/talents.spec.ts` per la feature Public Developer Profiles. I test coprono 4 gruppi: (1) **Talents List Page** (5 test, no auth): rendering pagina con talenti pubblici e verifica assenza utenti privati (6 card visibili, Andrea Conti non presente), ricerca per nome con debounce 350ms (Giulia visibile, Marco filtrato), filtro per livello esperienza Senior (Marco visibile, Luca filtrato), filtro per disponibilita' "Disponibile", empty state per ricerca senza risultati con messaggi corretti. (2) **Talent Detail Page** (5 test, no auth): navigazione lista->dettaglio con verifica sezioni (nome, ruolo, location, esperienza, formazione, TechFlow Italia), verifica privacy (email e telefono NON visibili), 404 per talento inesistente ("Talento non trovato"), link social LinkedIn e GitHub visibili (scoped a main per evitare conflitto col footer), CTA "Interessato a questo talento?" con link a Craft Your Developer. (3) **Profile Privacy Toggle** (2 test, auth required): visibilita' toggle (heading "Visibilita' Profilo" + role="switch"), toggle stato con verifica aria-checked cambia e ripristino stato originale per idempotenza. (4) **Navigation** (1 test): link "Scopri i Talenti" nella pagina CYD naviga correttamente a /it/talenti. Pattern seguiti: login helper riutilizzabile, locator scoped a getByRole('main') per evitare strict mode violations con elementi del footer, wait appropriati per debounce e API call, test idempotenti che ripristinano lo stato. Tutti i 36 test E2E (23 esistenti + 13 nuovi) passano stabilmente in ~14s per i soli talents e ~41s per l'intera suite
- **Company Accounts & Contact Flow (Backend)**: implementato il backend completo per il flusso aziendale "Craft Your Developer". (1) **Modello User esteso** con 5 nuovi campi (user_type talent/company, company_name, company_website, company_size, industry) e indice su user_type. (2) **2 nuovi modelli SQLAlchemy**: Proposal (company_id, talent_id, status con 5 stati draft/sent/accepted/rejected/completed, message, budget_range) e ProposalCourse (proposal_id, course_id, order, is_completed, completed_at con UniqueConstraint). (3) **Schema auth aggiornato** con campo user_type nel signup, model_validator per richiedere company_name quando user_type=company, e campi company in UserResponse. (4) **Schema profile aggiornato** con campi company in ProfileUpdate e ProfileResponse. (5) **Nuovi schema proposal**: ProposalCreate (talent_id, course_ids con min_length=1), ProposalUpdate (status con regex pattern), ProposalResponse (con courses, progress 0.0-1.0), ProposalListResponse. (6) **5 endpoint proposals**: POST /proposals (company crea proposta, valida talent pubblico e corsi attivi), GET /proposals (lista con filtro per user_type, talent non vede draft), GET /proposals/{id} (dettaglio con auth owner/recipient), PATCH /proposals/{id} (transizioni di stato: talent sent->accepted/rejected, company draft->sent e update message/budget su draft), PATCH /proposals/{id}/courses/{course_id} (talent completa corso, auto-complete proposta quando tutti i corsi sono completati). (7) **Dependency get_current_company_user** che wrappa get_current_user e verifica user_type=company con 403 se non lo e'. (8) **Seed ampliato** con 3 aziende (TechFlow Italia, AI Solutions Srl, DataSphere) e 3 proposte con corsi. (9) **47 nuovi test**: 37 per proposals routes (dependency, helper, CRUD completo, transizioni, auto-complete), 5 per company signup/auth, 5 per schema validation. Totale test: 194 (147+47). Scelta di usare model_validator invece di field_validator per la validazione company_name perche' il field_validator non scatta quando il campo Optional non e' fornito (default None non triggera il validatore). Scelta di settare esplicitamente id, created_at e updated_at nel route create_proposal perche' i default SQLAlchemy non scattano con mock DB nei test unitari
- **Test E2E Playwright per Company Accounts & Contact Flow**: creata suite completa di 29 test Playwright in `apps/web/e2e/proposals.spec.ts` per la feature Company Accounts & Contact Flow. Test organizzati in 8 gruppi: (1) **Company Signup Flow** (4 test): verifica tab talent/company nel form signup, campi company-specific (nome azienda, referente, email, sito web, settore con 11 opzioni), signup company con redirect a /it/talenti, validazione campo nome azienda required. (2) **Login Redirect Logic** (2 test): company login redirecta a /it/talenti, talent login redirecta a /it/jobs. (3) **Navbar Role-Based Items** (3 test): company vede "Le mie Proposte" e NON vede profilo/candidature, talent vede profilo/candidature e NON vede company proposals, avatar company mostra iniziale del company_name. (4) **Talent Detail Company CTA** (3 test): company autenticata vede "Proponi un Percorso" con link a nuova proposta, CTA naviga a pagina creazione proposta con talent_id, utente non autenticato vede CTA generico "Interessato a questo talento?". (5) **Proposal Creation Page** (4 test): display info talento e lista corsi, selezione/deselezione corsi con counter, submit proposta con redirect a dashboard, validazione "almeno un corso" senza corso selezionato. (6) **Company Proposals Dashboard** (4 test): tab status (Tutte/Bozze/Inviate/Accettate/Rifiutate/Completate), progress bar con "X di Y corsi completati", filtro tab funzionante, lista corsi espandibile. (7) **Talent Proposals Dashboard** (5 test): proposte ricevute con nome azienda, status badge colorati, lista corsi espandibile, bottone "Segna come completato" su proposta accettata, budget e progresso visibili. (8) **Auth Guards** (4 test): redirect a login per utente non autenticato su /it/proposte e /it/azienda/proposte, talent redirectato da /it/azienda/proposte a /it/proposte, company accede a /it/candidature (empty state). Credenziali di test: talent `marco.rossi@email.it`, company `hr@techflow.it` (dal seed reale). Helper login riutilizzabili `loginAsTalent` e `loginAsCompany`. Scoperto che le credenziali company specificate nel task (`hr@techvision.it`) non corrispondevano al seed reale (`hr@techflow.it`). Trovato bug server API che ritornava 500 per stale process — risolto con restart. Tutti i 65 test E2E (36 esistenti + 29 nuovi) passano stabilmente in ~1.7 minuti
- **Company Accounts & Contact Flow (Frontend)**: implementato il frontend completo per account aziendali e flusso di contatto con proposte formative. (1) **Auth types aggiornati**: aggiunti `user_type`, `company_name`, `company_website`, `company_size`, `industry` a `BackendUser` (auth.ts) e `User` (use-auth.ts). Aggiunto `isCompany: boolean` al return di `useAuth()` calcolato come `user?.user_type === "company"`. (2) **Signup con dual user type**: aggiunto toggle "Sono un Talento" / "Sono un'Azienda" con stile tab azure-600. Form company mostra campi aggiuntivi: nome azienda (required), nome referente, email aziendale, sito web (opzionale), settore (dropdown con 10 opzioni: Fintech, AI/ML, SaaS, E-commerce, HealthTech, EdTech, Cybersecurity, Data & Analytics, Consulenza, Altro). Redirect post-signup: talent -> /it/jobs, company -> /it/talenti. (3) **Login con redirect condizionale**: dopo login, company -> /it/talenti, talent -> /it/jobs tramite useEffect su `isCompany`. (4) **Navbar role-based**: per company: avatar con iniziale company_name, link "Le mie Proposte" a /it/azienda/proposte nel dropdown aziende e right-side; nascosti link talent-specific (profilo, candidature). Per talent: aggiunto link "Le mie Proposte" a /it/proposte nel dropdown talenti. Mobile menu con stessa logica. (5) **Talent detail con CTA company**: se isCompany && isAuthenticated, il CTA in fondo alla pagina diventa "Proponi un Percorso" con link a /it/azienda/proposte/nuova?talent_id={id} invece del generico "Scopri Craft Your Developer". (6) **Pagina proposte talent** (/it/proposte): auth guard (redirect login se non autenticato, redirect /it/azienda/proposte se company). Hero, tab status (Tutte/Inviate/Accettate/Rifiutate/Completate) con badge conteggio. Card proposta: company name + industry badge, messaggio troncato, budget range, status badge colorato (sent=azure, accepted=green, rejected=red, completed=purple), progress bar con "X di Y corsi completati", lista corsi espandibile con checkmark, bottoni Accetta/Rifiuta (status sent) e "Segna come completato" sui corsi (status accepted). Empty state con suggerimento di rendere profilo pubblico. (7) **Pagina proposte company** (/it/azienda/proposte): auth guard company-only. Stessa struttura della pagina talent ma con talent_name/talent_role al posto di company info. Empty state con link "Scopri i Talenti". (8) **Pagina creazione proposta** (/it/azienda/proposte/nuova): auth guard company. URL param talent_id per fetch e display info talento (avatar, nome, ruolo, location, skills read-only). Selezione corsi da catalogo con checkbox, ricerca inline, badge livello. Lista corsi selezionati riordinabile con frecce su/giu'. Textarea messaggio e input budget range opzionale. Submit con validazione (almeno 1 corso). Redirect a /it/azienda/proposte dopo successo. (9) **Traduzioni i18n**: 80+ nuove chiavi aggiunte per auth (company fields), nav (proposals links), proposals (titoli, sottotitoli, tab, status, card, actions, create, empty states), industry (10 settori), talents.detail (proposeTraining). TypeScript check passato con zero errori. Scelte architetturali: tutte le pagine seguono il pattern single-file del progetto; hook ordering rispettato (useTranslations -> useRouter -> useAuth -> useState); tutti gli elementi interattivi hanno cursor-pointer; API calls con accessToken da useAuth; nessun barrel file creato
- **Refactoring API: architettura domain-driven**: migrata l'intera struttura delle API da una struttura flat (routes come file singoli + cartella `schemas/` separata) a un'architettura domain-driven. Ogni feature e' ora una cartella con `__init__.py` (re-export router), `router.py` (handler) e `schemas.py` (Pydantic models co-locati). Le risorse figlie sono sotto-cartelle del genitore: `profile/experiences/` e `profile/educations/` sono figli di `profile/`, con composizione via `router.include_router()` nel `__init__.py` del genitore. `main.py` importa solo i router top-level. Struttura risultante: 8 domini top-level (auth, jobs, applications, news, courses, profile, talents, proposals) + 2 sotto-domini (experiences, educations). Aggiornati tutti e 9 i file di test con i nuovi import path. Eliminati tutti i file flat originali e l'intera cartella `schemas/`. Risolto un problema critico di naming collision: `__init__.py` che esporta `router` (oggetto APIRouter) shadowa il sotto-modulo `router.py` quando si usa `unittest.mock.patch` con path stringa — risolto con `importlib.import_module` + `patch.object`. 209 test passano al 100%. Code review approvata con 2 issue High (proposals router >150 righe, N+1 query in list_proposals), 5 Medium (Pydantic Config deprecato, hardcoded year 2030, \_helper cross-module, UserResponse/ProfileResponse duplicati), 4 Low. Aggiornati entrambi gli agenti BE (feature-builder e code-reviewer) con le nuove regole di architettura domain-driven prima del refactoring
- **Craft Your Developer flow completion (Backend)**: implementate 4 feature per completare il flusso CYD lato backend. (1) **Enhanced Training Execution + Gamification**: aggiunti 5 nuovi campi a ProposalCourse (started_at, talent_notes, company_notes, deadline, xp_earned) e 2 a Proposal (total_xp, hired_at, hiring_notes). Creato modello ProposalMilestone per tracciare i traguardi (course_started, course_completed, first_course, streak_3, 25/50/75/100 percent). Sistema XP basato sul livello del corso (beginner=100, intermediate=200, advanced=300) con bonus milestones (+10 start, +25 first course, +50 progress thresholds, +100 streak). 3 nuovi endpoint: PATCH .../start (talent avvia corso), PATCH .../notes (talent aggiorna note), PATCH .../company-update (company aggiorna note e deadline). Endpoint complete_proposal_course arricchito con calcolo XP, creazione milestones e tracking streak. (2) **Course Delivery Dashboard**: nuovo endpoint GET /proposals/{id}/dashboard che ritorna la ProposalResponse arricchita con tutti i campi computati (is_overdue, days_remaining, course_url, course_duration, course_category). (3) **Communication System**: creato sotto-dominio routes/proposals/messages/ con 3 file (router.py, schemas.py, **init**.py). Modello ProposalMessage con indici su proposal_id e created_at. 2 endpoint: GET (lista paginata ordinata ASC) e POST (creazione messaggio). Access control: solo company_id o talent_id della proposta, solo status accepted/completed/hired. Schema MessageResponse include sender_name e sender_type risolti dal modello User. Router incluso nel parent proposals/**init**.py. (4) **Hire After Training**: aggiunta transizione di stato accepted->hired e completed->hired. Quando si passa a "hired": si setta hired_at e hiring_notes sulla proposta, si aggiorna il talent con availability_status="employed" e adopted_by_company=company_name. ProposalUpdate schema aggiornato con regex che include "hired" e campo hiring_notes. (5) **Seed ampliato**: 4 proposte (1 accepted con progresso, 1 accepted vuota, 1 sent, 1 hired), milestones per proposte con progresso, 5 messaggi tra aziende e talenti, Sara Romano aggiornata come "employed" da DataSphere. (6) **Test completi**: 91 test proposte + 16 test messaggi = 107 test nuovi. Totale suite: 266 test, tutti passanti. Helper factories (\_make_proposal_course, \_make_course, \_make_milestone) per creare mock con tutti i campi impostati correttamente (evita MagicMock che ritorna sub-mock invece di None per i nuovi campi Optional). Scelta di usare helper \_fetch_proposal_data per DRY nel fetch dati correlati (company, talent, courses, milestones). Scelta di non modificare main.py: il messages router e' composto dal parent proposals/**init**.py tramite router.include_router()
- **Craft Your Developer Flow Completion (Frontend)**: implementate tutte e 4 le feature per completare il flusso CYD lato frontend, in parallelo con il backend agent. (1) **Enhanced Training Execution + Gamification UI**: aggiornati i type interfaces in entrambi i constants.ts (talent e company) con 11 nuovi campi su ProposalCourse (started_at, talent_notes, company_notes, deadline, xp_earned, course_url, course_duration, course_category, is_overdue, days_remaining) e 4 nuovi campi su Proposal (total_xp, milestones[], hired_at, hiring_notes). Aggiunto nuovo tipo Milestone e tipi ChatMessage/ChatMessagesResponse. Aggiunto status "hired" ai STATUS_TABS e statusBadgeStyle in entrambi i file. ProposalCard (talent) aggiornata con: XP counter con stella, milestone badges colorati sotto la progress bar, bottone "Inizia" per corsi non iniziati, badge "In corso" azure, deadline badge condizionale, link "Vai al Corso" esterno, box azure per company_notes, textarea editabile per talent_notes con salvataggio. CompanyProposalCard aggiornata con stessi elementi gamification + bottone "Assumi Talento" + form inline per company_notes e deadline. (2) **Proposal Detail Pages**: create pagine dettaglio /it/proposte/[id] (talent) e /it/azienda/proposte/[id] (company) con layout timeline verticale. Pattern ultra-thin page.tsx -> main client component. (3) **Communication System (Chat)**: creato ChatSection condiviso con polling ogni 10 secondi, chat bubbles, auto-scroll, input con send su Enter. (4) **Hire After Training**: HireConfirmationModal con warning se corsi incompleti, textarea per hiring notes, success toast, celebration header per stato hired. (5) **i18n**: 100+ nuove chiavi. (6) **Navigation**: Link dalle card ai dettagli. TypeScript zero errori. Scelte: ChatSection in proposte/[id]/\_components importato dalla company page; HireConfirmationModal in azienda/proposte/\_components; nessun barrel file
- **Challenge agent: PR review fixes e hardening**: eseguiti 7 fix identificati dal code review della PR. (1) **BE - Status check su notes/company-update**: aggiunti controlli di stato su update_course_notes e update_course_company — ora funzionano solo con status "accepted", "completed" o "hired", impedendo modifiche su proposte in stato "sent", "rejected" o "draft". (2) **BE - Rimosso parametro inutilizzato**: rimosso il parametro `course` da `_compute_course_fields(pc, course)` che non veniva mai usato, semplificando la firma. (3) **BE - Seed fix Sara Romano**: aggiunto `reskilling_status = "completed"` quando Sara Romano viene segnata come hired, coerenza con lo stato employed. (4) **FE - milestoneColor estratta**: funzione duplicata in 4 file componente estratta in entrambi i `_utils/constants.ts` (talent e company side), eliminati 4 blocchi di codice duplicato. (5) **FE - courseStatusIcon estratta**: funzione duplicata in 2 pagine dettaglio estratta in `proposte/_utils/courseStatusIcon.tsx` (file TSX perche' ritorna JSX con icone lucide-react), importata da entrambe le pagine dettaglio. Rimossi import inutilizzati (Check, Play) da AziendaPropostaDetailPage dopo l'estrazione. (6) **FE - Dead code e deduplicazione**: rimossa `formatBudget` (no-op: ritornava l'input invariato) da entrambi i constants.ts e tutti i 4 file che la importavano. Rimossa `formatDeadlineDate` (identica a `formatDate`), aggiornati tutti i caller per usare `formatDate`. (7) **FE - Accessibilita' htmlFor**: aggiunti `htmlFor` ai `<label>` e `id` ai `<input>` per le deadline in CompanyProposalCard e AziendaPropostaDetailPage, associando label e input per screen reader. Scritti 10 nuovi test per le status check (5 per notes: 3 reject su sent/rejected/draft + 2 success su completed/hired; 5 per company-update: 3 reject + 2 success). Totale test: 276 (era 266). TypeScript zero errori
- **E2E Suite Firefox cross-browser verification**: eseguita l'intera suite E2E (65 test) su Firefox dopo il testing manuale su Chromium. Installato Firefox via `npx playwright install firefox`. Primo run: 64/65 pass, 1 fail su "accepted proposal shows Segna come completato on courses" — il test cercava il vecchio testo bottone pre-gamification ("Segna come completato"), ma con il nuovo flusso i corsi non iniziati mostrano "Inizia" e quelli iniziati "Completa Corso". Fix: sostituito locator con regex `button hasText /^(Inizia|Completa Corso)$/` + `scrollIntoViewIfNeeded()` (i bottoni erano sotto il fold). Re-run: 65/65 pass su Firefox in 3.1 minuti. Nota: `locator.isVisible()` di Playwright non accetta timeout come parametro (e' un check istantaneo), quindi il pattern `Promise.race` con `isVisible({timeout})` non funziona — meglio usare `expect(locator).toBeVisible({timeout})` o `scrollIntoViewIfNeeded()` prima
- **E2E Testing manuale del flusso CYD completo**: eseguito test E2E completo con Playwright MCP browser tools su 3 parti. **Bug critici trovati e fixati**: (1) **Schema DB mismatch**: il database SQLite era stato creato prima dell'aggiunta dei campi CYD (total_xp, hired_at, hiring_notes su proposals; started_at, talent_notes, company_notes, deadline, xp_earned su proposal_courses) — SQLAlchemy create_all non aggiunge colonne a tabelle esistenti. Risolto eliminando il DB e ricreandolo con seed. (2) **Naive vs Aware datetime**: `TypeError: can't subtract offset-naive and offset-aware datetimes` in `_compute_course_fields` — la deadline da SQLite e' naive ma `datetime.now(timezone.utc)` e' aware. Fixato con check `pc.deadline if pc.deadline.tzinfo else pc.deadline.replace(tzinfo=timezone.utc)` in `apps/api/api/routes/proposals/router.py`. **Risultati test**: Part 1 (Company Flow): login azienda, dashboard proposte con XP/milestones/progress/status tabs, dettaglio con timeline corsi + chat + bottone assumi — tutti PASS. Part 2 (Talent Flow): login talento, dashboard proposte, avvio corso con XP +35 e milestones "Corso Iniziato"/"Primo Corso!", invio messaggio in chat, verifica stato hired con celebration 650 XP — tutti PASS. Part 3 (Full Round-Trip): login company -> browse talenti -> crea proposta per Elena Colombo (2 corsi AI, messaggio, budget 3.000-5.000) -> logout -> login come Elena -> vede proposta "Inviata" -> accetta -> status diventa "Accettata" -> avvia corso -> XP +35 e milestones -> invia messaggio in chat -> logout -> login company -> vede progresso Elena (35 XP, milestones, "In corso") -> legge messaggio Elena -> risponde in chat -> bidirectional chat funzionante — tutti PASS. Nota tecnica: il metodo Playwright `fill()` non triggera React `onChange` sugli input controllati — per la chat e' stato necessario usare `browser_evaluate` con native input value setter + dispatchEvent per aggiornare lo stato React, e poi `element.click()` via evaluate per il bottone send
